<template>
  <div class="green-jewel-border rounded">
    <div
      class="d-flex flex-column flex-sm-row align-items-start align-items-sm-center mb-4 p-3 extended-light-green-bg"
    >
      <div class="discount-icon me-3 mb-2 mb-sm-0">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="46"
          height="46"
          viewBox="0 0 46 46"
          fill="none"
        >
          <path
            fill-rule="evenodd"
            clip-rule="evenodd"
            d="M2.87615 0H29.7062C30.774 0 31.7113 0.584937 32.2067 1.44906C32.285 1.58575 32.4218 1.66468 32.5805 1.66532C32.7406 1.66468 32.8761 1.58638 32.955 1.44906C33.4505 0.585914 34.388 0 35.4555 0H43.1248C44.7062 0 46 1.28379 46 2.85277V19.9119C46 21.4803 44.7061 22.7637 43.1248 22.7637H36.5725C35.9917 22.7637 35.6466 22.1227 35.9713 21.6439L38.1633 18.4118C38.3421 18.1481 38.4763 17.8715 38.5727 17.5686C38.8841 16.5903 38.8935 15.311 38.8058 14.2948C38.6891 12.9449 37.7749 11.8274 36.4667 11.4372C34.5419 10.8622 33.0809 12.2516 32.5369 13.0284L25.0539 22.3958C24.8032 22.7105 24.4844 22.7638 24.257 22.7638H2.87524C1.29382 22.7638 0 21.48 0 19.9119V2.85281C0 1.28375 1.29481 0 2.87615 0ZM34.3813 13.6823L24.6553 25.8581C24.2323 26.3878 24.2323 27.1146 24.6553 27.6434L26.1368 29.4983C26.4337 29.8698 26.8525 30.0604 27.3291 30.0415C27.8058 30.0235 28.2084 29.8008 28.4743 29.4084L36.6267 17.3862C36.7085 17.2662 36.7628 17.1539 36.8065 17.0159C36.9918 16.4339 37.0461 15.444 36.9601 14.4529C36.9087 13.8535 36.5145 13.3719 35.9343 13.1986C35.3541 13.0253 34.7571 13.2113 34.3813 13.6823ZM20.8628 25.2519L31.0515 38.006C31.4419 38.4947 32.0728 38.6759 32.6669 38.469C33.0718 38.3281 33.508 38.2511 33.9615 38.2511C36.1189 38.2511 37.8668 39.9854 37.8668 42.1252C37.8668 44.2657 36.1189 46 33.9615 46C31.8051 46 30.0568 44.2657 30.0568 42.1252C30.0568 41.9792 30.0649 41.8355 30.0808 41.694C30.128 41.2737 30.0054 40.8941 29.7215 40.5777L25.2027 35.5536C25.0287 35.3601 24.8363 35.2331 24.5893 35.1496L20.9433 33.9185C20.6303 33.8129 20.3919 33.6323 20.2079 33.3602L15.2843 26.1003C15.1313 25.8738 15.1171 25.6013 15.2458 25.3613C15.3748 25.1207 15.6102 24.9805 15.8855 24.9805H20.2956C20.5245 24.9805 20.7208 25.0741 20.8628 25.2519ZM22.9781 30.8336C23.5408 30.8336 23.9965 31.2864 23.9965 31.845C23.9965 32.4026 23.5408 32.8554 22.9781 32.8554C22.4154 32.8554 21.9597 32.4026 21.9597 31.845C21.9597 31.2867 22.4154 30.8336 22.9781 30.8336ZM32.0906 42.1248C32.0906 43.1502 32.9289 43.9813 33.9618 43.9813C34.9953 43.9813 35.833 43.1507 35.833 42.1248C35.833 41.0999 34.9958 40.2682 33.9618 40.2682C32.967 40.2682 32.0906 41.1378 32.0906 42.1248ZM18.5373 33.5156L14.9509 38.0054C14.5596 38.4941 13.9287 38.6754 13.3349 38.4684C12.93 38.3275 12.4938 38.2505 12.0403 38.2505C9.88395 38.2505 8.13504 39.9848 8.13504 42.1247C8.13504 44.2652 9.88362 45.9994 12.0403 45.9994C14.1967 45.9994 15.9456 44.2652 15.9456 42.1247C15.9456 41.9787 15.9369 41.8349 15.9211 41.6934C15.8738 41.2731 15.9964 40.8935 16.2803 40.5771L20.8948 35.4468L19.998 35.1436C19.686 35.038 19.4476 34.8574 19.2636 34.5853L18.5373 33.5156ZM13.9112 42.1248C13.9112 43.1502 13.073 43.9813 12.04 43.9813C11.0071 43.9813 10.1688 43.1507 10.1688 42.1248C10.1688 41.0999 11.0071 40.2682 12.04 40.2682C13.0348 40.2682 13.9112 41.1378 13.9112 42.1248ZM32.3175 3.6358H33.018C33.2977 3.6358 33.5274 3.86297 33.5274 4.14116V6.42312C33.5274 6.70131 33.2984 6.92848 33.018 6.92848H32.3175C32.0372 6.92848 31.8082 6.70131 31.8082 6.42312V4.14116C31.8082 3.86297 32.0372 3.6358 32.3175 3.6358Z"
            fill="#138340"
          />
        </svg>
      </div>
      <div>
        <h4 class="mb-0 text-start fw-bold">
          {{ $t("discount.time_based_discount") }}
        </h4>
        <p class="text-muted mb-0">
          {{ $t("discount.give_discount_early_booking") }}
        </p>
      </div>
    </div>
    <div class="discount-config row px-3">
      <div class="col-12 col-md-6 mb-3">
        <div
          class="d-flex flex-column flex-sm-row justify-content-between align-items-sm-center mb-3"
        >
          <label for="days-input" class="me-2 mb-1 mb-sm-0">{{
            $t("discount.max_days_before_departure")
          }}</label>
          <div class="d-flex align-items-center">
            <input
              type="number"
              id="days-input"
              class="form-control form-control-sm text-center responsive-input"
              v-model.number="daysInput"
              min="1"
            />
            <span class="ms-2">{{ $t("discount.days") }}</span>
          </div>
        </div>

        <div
          class="d-flex flex-column flex-sm-row justify-content-between align-items-sm-center mb-4"
        >
          <label for="discount-percentage-input" class="me-2 mb-1 mb-sm-0">{{
            $t("discount.discount")
          }}</label>
          <div class="d-flex align-items-center">
            <input
              type="number"
              id="discount-percentage-input"
              class="form-control form-control-sm text-center responsive-input"
              style="margin-right: 0.45rem"
              v-model.number="discountPercentage"
              min="1"
              max="100"
            />
            <span class="ms-4">%</span>
          </div>
        </div>

        <button
          type="button"
          class="btn btn-outline-success btn-sm rounded-pill d-flex align-items-center ps-2 pe-3 mb-4"
          @click="addDiscountTier"
        >
          <span class="me-1">+</span> {{ $t("discount.add_discount") }}
        </button>

        <div v-if="errorMessage" class="text-danger mt-2 small">
          {{ errorMessage }}
        </div>
      </div>
      <!-- Vertical divider - only visible on md+ screens -->
      <div class="vertical-divider d-none d-md-block"></div>

      <!-- Horizontal divider - only visible on smaller screens -->
      <div class="col-12 d-md-none">
        <hr class="my-3" />
      </div>

      <div class="col-12 col-md-6">
        <DiscountTierList :discountTiers="discountTiers" @remove="removeTier">
          <template v-slot:remove="{ index }">
            <div>
              <button
                type="button"
                class="btn btn-sm text-success ms-0 ms-sm-1 d-flex align-items-center extended-light-green-bg"
                @click="removeTier(index)"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  fill="currentColor"
                  class="bi bi-x-circle-fill me-1"
                  viewBox="0 0 16 16"
                >
                  <path
                    d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"
                  />
                </svg>
                {{ $t("button.remove") }}
              </button>
            </div>
          </template>
        </DiscountTierList>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, watch } from "vue";
import { deepClone } from "@/utils";
import DiscountTierList from "./DiscountTierList.vue";
import type { TicketDiscount } from "@/store/sharebus/types";

const props = defineProps({
  discountTiers: {
    type: Array as () => TicketDiscount[],
    default: () => [],
  },
});

const emit = defineEmits(["update:discountTiers"]);

// Reactive state with default values from props
const discountTiers = ref<TicketDiscount[]>(
  deepClone(props.discountTiers || [])
);
const daysInput = ref(30);
const discountPercentage = ref(20);
const errorMessage = ref("");

// Helper function to validate a tier
const validateTier = (): { valid: boolean; message: string } => {
  if (!daysInput.value || daysInput.value < 1) {
    return { valid: false, message: "Days must be at least 1" };
  }

  if (
    !discountPercentage.value ||
    discountPercentage.value < 1 ||
    discountPercentage.value > 100
  ) {
    return {
      valid: false,
      message: "Discount percentage must be between 1% and 100%",
    };
  }

  if (discountTiers.value.some((tier) => tier.days === daysInput.value)) {
    return {
      valid: false,
      message: `A discount for ${daysInput.value} days already exists`,
    };
  }

  return { valid: true, message: "" };
};

// Show error message with auto-dismiss
const showError = (message: string) => {
  errorMessage.value = message;
  setTimeout(() => {
    errorMessage.value = "";
  }, 3000);
};

// Add a new discount tier
const addDiscountTier = () => {
  const validation = validateTier();

  if (!validation.valid) {
    showError(validation.message);
    return;
  }

  discountTiers.value.push({
    days: daysInput.value,
    percent: discountPercentage.value,
  });

  // Sort and emit updated tiers
  sortTiers();
};

// Remove a tier at the specified index
const removeTier = (index: number) => {
  discountTiers.value.splice(index, 1);
  // No need to explicitly sort here as we're just removing
  emit("update:discountTiers", deepClone(discountTiers.value));
};

// Sort tiers by days in ascending order
const sortTiers = () => {
  discountTiers.value.sort((a, b) => a.days - b.days);
  emit("update:discountTiers", deepClone(discountTiers.value));
};

// Initialize component
onMounted(() => {
  sortTiers();
});

// Watch for changes in props
watch(
  () => props.discountTiers,
  (newTiers) => {
    if (
      newTiers &&
      JSON.stringify(newTiers) !== JSON.stringify(discountTiers.value)
    ) {
      discountTiers.value = deepClone(newTiers);
    }
  },
  { deep: true }
);
</script>

<style scoped>
.discount-icon {
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.discount-tier {
  background-color: white;
  border-color: #dee2e6 !important;
  transition: all 0.3s ease;
}

.btn-outline-primary {
  border-color: #0d6efd;
  color: #0d6efd;
}

button.text-success {
  border: none;
  background: transparent;
  color: #198754;
  padding: 0.25rem 0.5rem;
  font-size: 0.875rem;
}

/* Vertical divider styling */
.vertical-divider {
  position: absolute;
  top: 10px;
  width: 1px;
  bottom: 10px;
  left: 50%;
  border-left: 1px solid #dee2e6;
  height: calc(100% - 20px);
}

/* Horizontal divider for small screens */
.horizontal-divider {
  height: 1px;
  border-bottom: 1px solid #dee2e6;
}

.discount-config {
  position: relative;
}

/* Responsive adjustments for small screens */
@media (max-width: 576px) {
  .time-based-discount {
    padding: 1rem !important;
  }

  .discount-tier {
    padding: 0.75rem !important;
    margin-bottom: 0.5rem !important;
  }

  button.text-success {
    padding: 0.15rem 0.35rem;
    font-size: 0.8rem;
  }

  .discount-icon {
    width: 30px;
    height: 30px;
  }

  .discount-icon svg {
    width: 30px;
    height: 30px;
  }
}

.responsive-input {
  width: 60px;
  border-top: none;
  border-left: none;
  border-right: none;
  border-bottom-color: #bfbfbf;
  transition: width 0.3s ease;
}

@media (max-width: 992px) {
  .responsive-input {
    width: 70px;
  }
}

@media (max-width: 768px) {
  .responsive-input {
    width: 65px;
  }
}

@media (max-width: 576px) {
  .responsive-input {
    width: 55px;
    font-size: 0.8rem;
  }
}
</style>
